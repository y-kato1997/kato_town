<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>kato.town</title>
  <meta name="description" content="加藤のためのサイト">
  <meta property="og:title" content="kato.town">
  <meta property="og:type" content="website" />
  <meta property="og:url" content="kato.town">
  <meta property="og:site_name" content="kato.click">
  <meta property="og:description" content="加藤のためのサイト">
  <meta property="og:image" content="./img/kato_thumbnail.png">
  <meta property="fb:app_id" content="3027674887272797">
  <link rel="apple-touch-icon" type="image/png" href="./img/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="./img/icon-192x192.png">
  <style>
    * {
      margin: 0px;
      padding: 0px;
      -ms-user-select: none;
      -moz-user-select: -moz-none;
      -khtml-user-select: none;
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>

<body>
  <script src="./js/p5.js"></script>
  <script>
    let katoImage;
    let katoCount = 0;
    let katoElements = [];
    let maxImageSize = 0;

    let isMouseHovering = false;
    let isTouchActive = false;

    document.body.addEventListener("mouseenter", () => {
      isMouseHovering = true;
    }, false);

    document.body.addEventListener("mouseleave", () => {
      isMouseHovering = false;
    }, false);

    document.body.addEventListener("touchstart", (e) => {
      e.preventDefault();
    }, { passive: false });

    document.body.addEventListener("touchmove", (e) => {
      e.preventDefault();
    }, { passive: false });

    function preload() {
      katoImage = loadImage('./asset/kato.svg');
    }

    function setup() {
      createCanvas(windowWidth, windowHeight, WEBGL);
      angleMode(DEGREES);
      updateMaxImageSize();

      //生成される文字の数(5~10個)
      const maxElements = Math.floor(Math.random() * 5) + 5;

      for (let i = 0; i < maxElements; i++) {
        katoElements.push(createKatoElement());
      }
    }

    function draw() {
      background(17, 17, 17);

      for (const element of katoElements) {
        if (element.count === 0) {
          katoCount++;
        }

        element.size += 0.5;
        element.rotation += 0.02;
        element.opacity -= 1.5;
        element.count++;

        imageMode(CENTER);
        push();

        translate(element.x, element.y, element.z);
        rotateZ(element.rotation);
        tint(255, element.opacity);

        const imageWidth = element.size;
        const imageHeight = element.size * (katoImage.height / katoImage.width);
        image(katoImage, 0, 0, imageWidth, imageHeight);

        pop();

        if (element.opacity < 0) {
          Object.assign(element, createKatoElement());
        }
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      updateMaxImageSize();
    }

    function updateMaxImageSize() {
      const sizeFactor = 6;
      maxImageSize = height > width ? height / sizeFactor : width / sizeFactor;
    }

    function createKatoElement() {
      let posX = 0;
      let posY = 0;

      switch (true) {
        case isMouseHovering:
          [posX, posY] = calculatePositionWithGravity(mouseX, mouseY);
          break;
        case isTouchActive:
          let fingerNum = round(random(0, touches.length-1));
          [posX, posY] = calculatePositionWithGravity(touches[fingerNum].x, touches[fingerNum].y);
          break;
        default:
          posX = round(random(-width / 2, width / 2));
          posY = round(random(-height / 2, height / 2));
          break;
      }

      return {
        x: posX,
        y: posY,
        z: 0,
        size: round(random(1, maxImageSize)),
        opacity: round(random(50, 255)),
        rotation: round(random(-140, 140)),
        count: 0
      };
    }

    function calculatePositionWithGravity(x, y) {
      const factor = (random() ** 2) * 0.5;
      const directionX = random() < 0.5 ? -1 : 1;
      const directionY = random() < 0.5 ? -1 : 1;

      const distanceX = directionX === 1 ? width - x : x;
      const distanceY = directionY === 1 ? height - y : y;

      return [
        (x - width / 2) + (distanceX * factor * directionX),
        (y - height / 2) + (distanceY * factor * directionY)
      ];
    }

    function touchStarted() {
      isTouchActive = true;
    }

    function touchEnded() {
      isTouchActive = false;
    }
  </script>
</body>

</html>